# vsi_to_tif

This repository is designed to convert multiple image files with the `vsi` format to 
[OME-TIFF](https://docs.openmicroscopy.org/ome-model/5.6.3/ome-tiff/) at once using 
[Snakemake](https://snakemake.readthedocs.io/en/stable). The `vsi` image files generated 
by Olympus microscopes (e.g. [Olympus VS200 scanner](https://www.olympus-global.com/news/2019/nr01430.html))
have limited compatibility with image processing tools. Converting individual `vsi` 
images using [Fiji](https://imagej.net/software/fiji/) with [Bio-Formats](https://bio-formats.readthedocs.io/en/v8.3.0/about/index.html) or 
[QuPath](https://qupath.github.io/) has been a common solution with substantial effort and time, 
depending on the input load. 

Here, I’d like to share a simple Snakemake pipeline that allows parallel 
conversion of multiple input `vsi` images at once. This approach uses 
[`bftools`](https://bio-formats.readthedocs.io/en/v8.3.0/users/comlinetools/index.html), 
a collection of command-line tools provided by 
the Bio-Formats library.
Refer to the following documentation about commands used in the current 
workflow:

- [`showinf`](https://bio-formats.readthedocs.io/en/v8.3.0/users/comlinetools/display.html)
- [`bfconvert`](https://bio-formats.readthedocs.io/en/v8.3.0/users/comlinetools/conversion.html)

## Package installation

Packages were installed using the [Conda](https://docs.conda.io/en/latest/) package manager.
For more detailed information about packages and versions, refer to 
the `env.archived.yaml` file.

## Scripts

- `snakemake/Snakefile`: Running Snakemake pipeline to convert `vsi` to `tif`
- `snakemake/config/config.yaml`: Configuring Snakemake
- `snakemake/config/WRAPPER_SLURM`: Optionally enabling Snakemake to run on a cluster. 
The Snakemake profile is cluster-specific. The current wrapper is for the 
[Slurm cluster of NIH Biowulf](https://hpc.nih.gov/docs/userguide.html). If you are new
to setting up your Snakemake profile, follow the instructions in 
*[Setting up Snakemake profile](#setting-up-snakemake-profile)*.
- `snakemake/config/sampletable.txt`: 
Specifying sample names and corresponding input image paths
- `snakemake/image_conversion.Rmd`: 
Wrapper script running `bftools` for image conversion

## Setting up Snakemake profile

This demonstration is for users of [NIH Biowulf](https://hpc.nih.gov/). If you are an NIH user, 
follow the one-time setup below. Otherwise, consult with your HPC staff.
If you don't use HPC, disregard the current section.

1. Clone the [snakemake_profile](https://github.com/NIH-HPC/snakemake_profile) GitHub repository

```bash
# Clone the repo for Snakemake<8
$ git clone https://github.com/NIH-HPC/snakemake_profile.git <path/to/snakemake_profile>

# Clone the repo for Snakemake>=8
$ git clone https://github.com/NIH-HPC/snakemake_profile.git <path/to/snakemake_profile_v8>
$ cd <path/to/snakemake_profile_v8>
# Change active branch to make it compatible with Snakemake>=8
$ git checkout snakemake8
```

2. Add the paths to your Snakemake profile to your bash configuration (`~/.bashrc`)

```bash
# Add env var for Snakemake<8
$ echo '$SNAKEMAKE_PROFILE=<path/to/snakemake_profile>' >> ~/.bashrc
# Add env var for Snakemake>=8
$ echo '$SNAKEMAKE_PROFILE_V8=<path/to/snakemake_profile_v8>' >> ~/.bashrc
```

3. Update your bash configuration

```bash
$ source ~/.bashrc
```

## Configuration (`snakemake/config/config.yaml`)

- `conda_env`: String. A path to your conda environment.

- `sampletable`: String. A path to your sampletable. The sampletable is 
a tab-separated file consisting of two columns below

    - *samplename*: unique sample identifiers
    - *input_vsi*: paths to input `vsi` image files

- `outdir`: String. A path to output directory. 

- `ser`: String. A series to be converted. If set to *None*, a multi-channel 
series with the highest resolution is selected. Otherwise, specify a series 
of interest based on the metadata.

- `pyramidal`: String. *Y* or *N*. If set to *Y*, the output image forms a pyramidal 
structure, being progressively downscaled throughout the series. For more details about
a pyramidal image, refer to 
[What is a pyramidal image?](https://www.microscopesinternational.com/support/kb/article/ngn1076.aspx).


## Sampletable (`snakemake/config/sampletable.tsv`)

The *sampletable* consists of two columns below:


| samplename | input_vsi |
|---|---|
| perm     | ../images/input/Perm/Image_168.vsi |
| noperm   | ../images/input/NoPerm/Image_169.vsi |


Note that the *samplename* column must contain unique names corresponding to individual 
samples and that changing column names will result in failure of reading this table 
in the Snakemake pipeline. Ensure that your sampletable is a **tab-separated file**.

## Input VSI files

Converting image formats requires the entire files generated by the microscope. Ensure
to maintain all files and structures unchanged, as demonstrated below.

```bash
# Assume you call the `tree` command in the `Perm` directory
# These files were generated using the VS200 scanner
$ tree
.
├── _Image_168_
│   ├── stack1
│   │   └── frame_t.ets
│   ├── stack10000
│   │   ├── blob_21_f_Frame#0.ets
│   │   ├── blob_21_f.meta
│   │   └── frame_t.ets
│   └── stack10002
│       └── frame_t_0.ets
├── Image_168.vsi
└── tiffzoom
    ├── _Image_01_
    │   └── stack10000
    │       ├── blob_21_f_Frame#0.ets
    │       └── blob_21_f.meta
    ├── Image_01.vsi
    ├── _Image_03_
    │   └── stack10000
    │       ├── blob_21_f_Frame#0.ets
    │       └── blob_21_f.meta
    └── Image_03.vsi

9 directories, 12 files
```

## Output files

Once you complete the run, the output directory will contain the following 
output files:

```bash
# Assume you are in the input directory
$ tree
.
├── noperm
│   ├── converted.ome.tif
│   ├── image_conversion.html
│   ├── input_metadata.txt
│   └── output_metadata.txt
└── perm
    ├── converted.ome.tif
    ├── image_conversion.html
    ├── input_metadata.txt
    └── output_metadata.txt

2 directories, 8 files
```

- `converted.ome.tif`: output converted OME-TIFF file
- `image_conversion.html`: summary of image conversion process
- `input_metadata.txt`: metadata of input `vsi` image
- `output_metadata.txt`: metadata of output OME-TIFF image

## Further steps

Converted images can be loaded as a NumPy array in Python for further 
image analyses.

```python
# Load required packages
import dask.array as da
from dask_image.imread import imread as dask_imread

# Read image lazily using dask
img_array = dask_imread(input_image)
```

